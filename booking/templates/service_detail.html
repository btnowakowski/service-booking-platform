{% extends "base.html" %}
{% block content %}
<!-- <div id="no-slots-msg" class="alert alert-info mt-3 d-none">
  Brak wolnych terminów.
</div> -->

<div class="row g-4">
  <div class="col-lg-4">
    <div class="card-soft p-4">
      <h2 class="mb-1">{{ object.name }}</h2>
      <p class="text-muted-2 mb-3">{{ object.description }}</p>

      <div class="d-flex align-items-center justify-content-between mb-3">
        <span class="text-muted-2">Cena</span>
        <span class="fs-5 fw-semibold">{{ object.price }} zł</span>
      </div>

      {% if user.is_authenticated %}
        <div id="reservation-info"class="alert alert-info small mb-3">
          Kliknij wolny termin w kalendarzu, aby go zarezerwować.
        </div>

        <form id="booking-form" method="post"
              action="{% url 'booking:reservation_create' object.id %}"
              class="d-none">
          {% csrf_token %}
          <input type="hidden" name="slot" id="slot-input">

          <div class="card-soft p-3 mb-2">
            <div class="small text-muted-2">Wybrany termin:</div>
            <div id="slot-preview" class="fw-semibold"></div>
          </div>

          <button type="submit" class="btn btn-primary w-100">
            Rezerwuj termin
          </button>
        </form>
      {% else %}
        <p class="mt-3">
          <a href="/accounts/login/">Zaloguj się</a>, żeby zarezerwować.
        </p>
      {% endif %}
    </div>
  </div>

  <div class="col-lg-8">
    {% if user.is_authenticated %}
      <div class="card-soft p-3 calendar-wrap position-relative">
        <div id="calendar-placeholder"
            class="d-none h-100 d-flex flex-column justify-content-center align-items-center text-center p-4">
          <div class="fs-4 fw-semibold mb-2">Brak terminów w tym tygodniu</div>
          <div class="text-muted-2 mb-3">Spróbuj zmienić zakres albo wróć później.</div>
        </div>
        <div id="calendar" data-service-id="{{ object.id }}" style="height:100%;"></div>
      </div>
    {% else %}
      <div class="card-soft p-4">
        <p>Zaloguj się, aby zobaczyć dostępne terminy.</p>
      </div>
    {% endif %}
  </div>
</div>

<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/locales-all.global.min.js"></script>


<script>
document.addEventListener('DOMContentLoaded', async () => {
  const calendarEl = document.getElementById('calendar');
  if (!calendarEl) return;

  const serviceId = calendarEl.dataset.serviceId;

  async function fetchSlots() {
    const res = await fetch(`/api/services/${serviceId}/slots/`);
    const slots = await res.json();

    // const msg = document.getElementById("no-slots-msg");
    const cal = document.getElementById("calendar");
    const ph = document.getElementById("calendar-placeholder");
    const ri = document.getElementById("reservation-info")
    if (slots.length === 0) {
      // msg.classList.remove("d-none");
      ri.classList.add("d-none")
      cal.classList.add("d-none");   
      ph.classList.remove("d-none");  
    } else {
      // msg.classList.add("d-none");
      ri.classList.remove("d-none")
      cal.classList.remove("d-none");
      ph.classList.add("d-none");
    }
    return slots.map(s => ({
      id: s.id,
      title: "Wolny termin",
      start: s.start,
      end: s.end
    }));
  }

  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'timeGridWeek',
    locale: 'pl',
    timeZone: 'local',

    buttonText: {
      today: 'Dziś',
      week: 'Tydzień',
      day: 'Dzień'
    },

    allDayText: 'Cały dzień',
    noEventsText: 'Brak wolnych terminów',

    height: "100%",
    expandRows: true,
    nowIndicator: true,
    slotMinTime: "09:00:00",
    slotMaxTime: "22:00:00",

    headerToolbar: {
      left: "prev,next today",
      center: "title",
      right: "timeGridWeek,timeGridDay"
    },

    views: {
      timeGridWeek: { buttonText: "Tydzień" },
      timeGridDay: { buttonText: "Dzień" }
    },

    events: await fetchSlots(),

    eventClick: function(info) {
      const calendarApi = info.view.calendar;

      const formatted = calendarApi.formatDate(info.event.start, {
        locale: 'pl',
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });

      document.getElementById("slot-input").value = info.event.id;
      document.getElementById("slot-preview").textContent = formatted;
      document.getElementById("booking-form").classList.remove("d-none");
    },

    datesSet: async function() {
      const events = await fetchSlots();
      calendar.removeAllEvents();
      calendar.addEventSource(events);
    }
  });


  calendar.render();
});
</script>

{% endblock %}
